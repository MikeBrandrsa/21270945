---
output:
  md_document:
    variant: markdown_github
---
Financial Econometrics Practical

# Outline

This Readme will outline all the following questions by means of explaining, interpreting and reasoning through all the necessary code and functions, whereafter a simplified output will be reproduced within each respective question folders.

First, I sanitize my working environment and source all the necessary functions that will be incorporated into our analyses.
```{r, include=FALSE}

rm(list = ls())
gc()
library(tidyverse)
list.files('code/', full.names = T, recursive = T) %>% .[grepl('.R', .)] %>% as.list() %>% walk(~source(.))
```

```{r, include=FALSE}
# this is a commented out chunk indicating the process by which the questions folders where produced.

# HTML Texevier:
#Texevier::create_template_html(directory = "/Users/michaelbrand/OneDrive/Documents/UNI/2021/2/Fin.Metrics/Test/21270945/Questions",
 #                         template_name = "Question1"
#)
#Texevier::create_template_html(directory = "/Users/michaelbrand/OneDrive/Documents/UNI/2021/2/Fin.Metrics/Test/21270945/Questions",
#                         template_name = "Question2"
#)
#Texevier::create_template_html(directory = "/Users/michaelbrand/OneDrive/Documents/UNI/2021/2/Fin.Metrics/Test/21270945/Questions",
#                         template_name = "Question3"
#)
#Texevier::create_template_html(directory = "/Users/michaelbrand/OneDrive/Documents/UNI/2021/2/Fin.Metrics/Test/21270945/Questions",
#                          template_name = "Question4"
#)
#Texevier::create_template_html(directory = "/Users/michaelbrand/OneDrive/Documents/UNI/2021/2/Fin.Metrics/Test/21270945/Questions",
#                          template_name = "Question5"
#)
#Texevier::create_template_html(directory = "/Users/michaelbrand/OneDrive/Documents/UNI/2021/2/Fin.Metrics/Test/21270945/Questions",
#                          template_name = "Question6"
#)
```
Now I procceed with the respective questions.

# Question 1: Yield Spread.

Since the beginning of 2020 the current Yield spreads in local mid to longer dated bond yields have been the highest in decades. This is conventionally expressed as the difference in these yields of these instruments in percentage points or basis points.

```{r, include= FALSE}
library(tidyverse)
SA_bonds <- read_rds("data/SA_Bonds.rds")
#BE_Infl <- read_rds("data/BE_Infl.rds")
#bonds_2y <- read_rds("data/bonds_2y.rds")
#bonds_10y <- read_rds("data/bonds_10y.rds")
#usdzar <- read_rds("data/usdzar.rds")
#ZA_Infl <- read_rds("data/ZA_Infl.rds")
#IV <- read_rds("data/IV.rds")

```

```{r, echo=FALSE}
library(tbl2xts)
library(PerformanceAnalytics)

bond_Adj <- 
SA_bonds %>% gather(Bond, Yield, -date) %>% arrange(date) 

bondplot1 <- bond_Adj %>% 
ggplot() + 
geom_line(aes(x = date, y = Yield, color = Bond), alpha = 0.8, 
    size = 1.2)

bondplot1 <- bondplot1 + fmxdat::theme_fmx() + theme(legend.position = "bottom") + labs(x = "date", 
    y = "Yield", title = "Yield of ZAR Bonds.", subtitle = "Using 3 Month, 2 Year and 10 year bond yields.", caption = "Note:\nNico Katzke's data used")

print(bondplot1)

```
we notice several places where rates stagnate and thus check for missing values in the data.
```{r, echo=FALSE, include=FALSE}
is.na(bond_Adj)
sum(is.na(bond_Adj))
```
it appears that all the data is present.

Now at first glance an immediate divergence can be observed between the three bond yields, specifically with the three-month and two-year yields diverging from the longer 10 year bond yield. Before investigating this from an economic and quantitative perspective it is worth investigating it more formally.
```{r}
bond_Adj_yield <- SA_bonds %>%
    arrange(date) %>% 
mutate("10Yr2Yr_spread" = ZA_10Yr - ZA_2Yr,"10Yr3M_spread" = ZA_10Yr - SA_3M,"2Yr3M_spread" = ZA_2Yr - SA_3M ) %>% select(date, "10Yr3M_spread","10Yr2Yr_spread","2Yr3M_spread" )

bond_Adj_yield_tdy <- bond_Adj_yield %>% gather(bondpair, Spread , -date) %>% arrange(date) 

bondplot2 <- bond_Adj_yield_tdy %>% ggplot() + geom_line(aes(x = date, y = Spread, color = bondpair), alpha = 0.8, size = 1.2) 

bondplot2 <- bondplot2 + fmxdat::theme_fmx() + theme(legend.position = "bottom") + labs(x = "date", 
    y = "Yield Spread", title = "Yield Spread of ZAR Bonds.", subtitle = "Using 3 Month, 2 Year and 10 year bond yields.", caption = "Note:\nNico Katzke's data used")

print(bondplot2)
```

```{r}
bond_Adj_yield_tdy2010 <- bond_Adj_yield %>% gather(bondpair, Spread , -date) %>% arrange(date) %>% 
    filter(date > "2010-01-01")

bondplot3 <- bond_Adj_yield_tdy2010 %>% ggplot() + geom_line(aes(x = date, y = Spread, color = bondpair), alpha = 0.8, size = 1.2) 

bondplot3 <- bondplot3 + fmxdat::theme_fmx() + theme(legend.position = "bottom") + labs(x = "date", 
    y = "Yield Spread", title = "Yield Spread of ZAR Bonds.", subtitle = "Using 3 Month, 2 Year and 10 year bond yields.", caption = "Note:\nNico Katzke's data used")

print(bondplot3)
```
\newpage

# Question 2: Portfolio Construction

```{r, include=FALSE}
T40 <- read_rds("data/T40.rds")
RebDays <- read_rds("data/Rebalance_days.rds")
``` 

```{r}
library(PerformanceAnalytics)
library(tbl2xts)

# effrtnsQ2 <- T40 %>% arrange(date) %>% gather(Tickers, Return, -date) %>% 
   # tbl2xts::tbl_xts(cols_to_xts = Return, spread_by = Tickers) %>% 
   # PerformanceAnalytics::Return.calculate(., method = "log") %>% 
   # tbl2xts::xts_tbl()

# porteqw <- rmsfuns::Safe_Return.portfolio(Rtn, weight = Wt, geometric = FALSE)
### use this ####
    ####    ####
```




```{r}

# j400j200effectivereturns <- T40 %>% select(date, Tickers, Return, J400, J200) %>% 
  #  arrange(date) %>% mutate(effj200rtn = Return*J200) %>% 
  #  mutate(effj400rtn = Return*J400) %>% select(date,effj200rtn,effj400rtn) 

#Cum_JJRtn <- j400j200effectivereturns %>% arrange(date) %>% 
  #  mutate(CumJ2Rtn = (cumprod(1 + effj200rtn))) %>% mutate(CumJ4Rtn = (cumprod(1 + effj400rtn)))# Start at 1)
```


# Question 3: Volatility Comparison

get return series for just j200
```{r}
#pacman::p_load("tidyverse", "devtools", "FactoMineR", "factoextra", 
   # "broom", "rmsfuns")
#T40 <- read_rds("data/T40.rds")
#Q2ALSIRTN <- T40  %>% arrange(date) %>% select(date, Tickers, Return, J200) %>% drop_na()
#colSums(is.na(Q3ALSIRTN))
#WghtALSIRTN <- Q3ALSIRTN %>% mutate(effectivereturn = Return*J200) %>% 
 #   group_by(date) %>% summarise(portfolio_return = sum(effectivereturn)) %>% ungroup()
 # this is for Q2 

```

```{r}
pacman::p_load("tidyverse", "devtools", "FactoMineR", "factoextra", 
    "broom", "rmsfuns")
T40 <- read_rds("data/T40.rds")
Q3ALSIRTN <- T40  %>% arrange(date) %>% select(date, Tickers, Return, J200) %>% drop_na() %>% select(date, Tickers, Return) %>% mutate(Return = ifelse(Return > 0.25, 0.25, 
    ifelse(Return < -0.25, -0.25, Return)))
colSums(is.na(Q3ALSIRTN))
```

```{r}
Q3plot1 <- Q3ALSIRTN %>% ggplot() + geom_line(aes(date, Return, color=Tickers, alpha =0.9)) +
                                                   labs(x = "date", y = "Returns", title = "top40 ALSI Returns", subtitle = "", caption = "Note:\nNico Katzke's data used")
Q3plot1
```

```{r}

Q3centered <- Q3ALSIRTN %>% group_by(Tickers) %>% mutate(Return = Return - mean(Return)) %>% ungroup() %>% spread(Tickers, Return)


set.seed(1234)
        NAll <- nrow(Q3centered %>% gather(Return, Returns, -date))

Q3centered <- bind_cols(
          Q3centered %>% gather(Tickers, Return, -date),
          Q3centered %>% gather(Tickers, Return, -date) %>%
            mutate(Dens = list(density(Return, na.rm=T))) %>%
            summarise(Random_Draws = list(sample(Dens[[1]]$x, NAll, replace = TRUE, prob=.$Dens[[1]]$y))) %>% 
            unnest(Random_Draws)) %>% mutate(Return = coalesce(Return, Random_Draws)) %>% select(-Random_Draws) %>% spread(Tickers, Return)
return(Q3centered)
any(is.na(Q3centered))
```
\newpage
```{r}
Q3centemax <- Q3centered %>% select(-date)
Q3covmat <- cov(Q3centemax)  
```

```{r}
# eigenvectors:
evec <- eigen(Q3covmat, symmetric = TRUE)$vector
# eigenvalues:
eval <- eigen(Q3covmat, symmetric = TRUE)$values

lambda = diag(t(evec) %*% Q3covmat %*% evec)
# Which should be equal to eval:
all.equal(lambda, eval)

prcomp(Q3covmat)
prop = eval/sum(eval)
print(prop)
```

```{r}
prop <- tibble(Loadings = prop) %>% mutate(PC = paste0("PC_", 
    row_number()))

prop[, "PC"][[1]] <- factor(prop[, "PC"][[1]], levels = prop$PC)
Prop2 <- prop %>% slice_head(n=10)
g <- Prop2 %>% 
ggplot() + geom_bar(aes(PC, Loadings), stat = "identity", fill = "steelblue") + 
    
fmxdat::theme_fmx(axis.size.title = fmxdat::ggpts(38), axis.size = fmxdat::ggpts(35), 
    title.size = fmxdat::ggpts(42), CustomCaption = T) + 
scale_y_continuous(breaks = scales::pretty_breaks(10), labels = scales::percent_format(accuracy = 1)) + 
labs(x = "Principal Components", y = "Loadings", title = "Eigenvalue proportions", 
    caption = "Source: Fmxdat Package")
g
```


```{r}
#pcaseries <- Q3ALSIRTN %>% spread(Tickers, Return) %>% select(-date)
#demean = scale(pcaseries, center = TRUE, scale = TRUE)


#Q3ALSIRTN

#sigma <- cov(demean )

#evec <- eigen(sigma, symmetric = TRUE)$vector  #eigen vectors
#eval <- eigen(sigma, symmetric = TRUE)$values  #eigen values

# or done automagically (using standard covariance matrix
# warts and all):
#pcrun <- prcomp(demean, center = T, scale. = T)
#ev <- pcrun$rotation

#e_min1 <- solve(ev)  # Invert eigenvector as in equation above)
#R_PCA <- e_min1 %*% t(pcaseries)  # Note: pcaseries, not demean.

#PC_Series <- t(R_PCA) %>% tibble::as_tibble()

#PC_Series <- PC_Series %>% mutate(date = unique(Spots$date)) %>% 
    #gather(Type, Val, -date)

#---- Let's look at these series:

# Returns:
#PC_Series %>% filter(Type %in% paste0("PC", 1:5)) %>% ggplot() + 
    #geom_line(aes(date, Val, color = Type))



```
now we add the supplementary variables.
```{r}
library(PerformanceAnalytics)
library(tbl2xts)
rf <-read_rds("data/SA_Bonds.rds") %>% 
    select(date, SA_3M) %>%  gather(Bond, Yield, -date) %>%
    arrange(date)
rfxts <- tbl_xts(rf)

xtsQ3ALSIRTN <- tbl_xts(Q3ALSIRTN)
chart.RollingCorrelation(Ra = xtsQ3ALSIRTN , Rb=rfxts, width = 100, xaxis = TRUE,
  legend.loc = NULL, colorset = (1:12), fill = NA)

```


# Question 4: Volatility and GARCH estimates


```{r}
cncy <- read_rds("data/currencies.rds")
cncy_Carry <- read_rds("data/cncy_Carry.rds")
cncy_value <- read_rds("data/cncy_value.rds")
cncyIV <- read_rds("data/cncyIV.rds")
bbdxy <- read_rds("data/bbdxy.rds")
PPP <- read_csv("data/ppp.csv", col_names = T ) 
```

vol compared to other currencies or are they all vol.

```{r}
Q4cncieszar <- cncy %>% spread(Name, Price) %>% select(date, SouthAfrica_Cncy) %>% gather(Spot, Price, -date) %>% mutate(Spot = gsub("_Cncy", "", Spot)) %>%
    mutate(Spot = gsub("SouthAfrica", "USD/ZAR", Spot))

Q4cnciesplot <- Q4cncieszar %>% ggplot() +  geom_line(aes(date, Price, color = Spot)) + fmxdat::theme_fmx() + labs(x = "date", 
    y = "Spot Price", title = "USDZAR Spot Rate.", subtitle = "Changes in the strength of the ZAR overtime.", caption = "Note:\nNico Katzke's data used")
Q4cnciesplot
```

```{r}
# Q4value <- cncy_value %>%  spread(Name, Price)
#%>%  select(date, SouthAfrica_Cncy) %>% gather(Spot, Price, -date) %>% mutate(Spot = gsub("_Cncy", "", Spot)) %>%
   # mutate(Spot = gsub("SouthAfrica", "USD/ZAR", Spot))

```

```{r}
library(lubridate)
Q4PPP <- PPP %>% select(TIME, LOCATION, Value) %>% spread(LOCATION, Value) %>% 
    select(TIME, ZAF, USA) %>% gather(Spot, Price, -TIME)# %>%  mutate(YearMonth = format(date, "%Y%B"))

Q4cnciesplot2 <- Q4PPP %>% ggplot() +  geom_line(aes(TIME, Price, color = Spot)) + fmxdat::theme_fmx() + labs(x = "date", 
    y = "Spot Price", title = "USDZAR Spot Rate.", subtitle = "Changes in the strength of the ZAR overtime.", caption = "Note:\nNico Katzke's data used")
Q4cnciesplot2
```

```{r}
library(tbl2xts)

Q4dlogzar <- Q4cncieszar %>% mutate(Price = na.locf(Price)) %>% arrange(date)  %>% mutate(dlogret = log(Price) - log(lag(Price))) %>% mutate(scaledret = (dlogret -  mean(dlogret,na.rm =T))) %>% filter(date > dplyr::first(date))
    






```
